<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MCIF Weekly Task Scheduler â€” Enterprise (v2)</title>
<link rel="icon" href="data:," />
<style>
/* =========================
   Visual system â€” modern, calm,
   dopamine-friendly micro-interactions
   ========================= */
:root{
  --bg0: #071021; --bg1:#0f1724; --panel:#071422;
  --muted:#9fb0bf; --text:#e8f6f3; --accent:#54e0c7; --accent-2:#60a5fa;
  --danger:#ff7b7b; --glass: rgba(255,255,255,0.03);
  --radius:12px; --card-radius:14px; --gap:12px;
  font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  color-scheme: dark;
}
*{box-sizing:border-box}
html,body{height:100%; margin:0; background: linear-gradient(180deg,var(--bg0),#061422 160%); -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale}
body{
  padding:18px; display:flex; align-items:flex-start; justify-content:center; font-size:15px; color:var(--text);
}

/* App container */
.app{
  width:100%; max-width:1260px; display:grid; gap:18px;
  grid-template-columns: 1fr; align-content:start;
  margin-bottom:48px;
}

/* Header */
.header{
  display:flex; align-items:center; justify-content:space-between; gap:12px;
}
.brand{
  display:flex; gap:12px; align-items:center;
}
.logo{
  width:48px; height:48px; border-radius:10px; display:grid; place-items:center;
  background:linear-gradient(135deg,var(--accent),var(--accent-2)); color:#012329; font-weight:800;
  box-shadow: 0 6px 20px rgba(0,0,0,0.6);
}
.title{line-height:1}
.title h1{margin:0;font-size:18px}
.title p{margin:0;color:var(--muted);font-size:13px}

/* Top controls */
.controls{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
.btn{
  background:var(--glass); color:var(--accent); border:1px solid rgba(255,255,255,0.03);
  padding:8px 12px; border-radius:999px; cursor:pointer; font-weight:700;
}
.btn.ghost{background:transparent;color:var(--muted); border:1px solid rgba(255,255,255,0.02)}
.btn.danger{background:linear-gradient(90deg,#3b0f0f,#5b1b1b); color:white}
.kbd{background:rgba(255,255,255,0.03); padding:6px 8px; border-radius:8px; font-weight:700; font-size:13px}

/* Main grid */
.main{
  display:grid; grid-template-columns: 360px 1fr; gap:18px;
}

/* Left panel */
.panel{
  background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.03));
  border-radius:var(--card-radius); padding:14px; border:1px solid rgba(255,255,255,0.03);
  box-shadow: 0 10px 30px rgba(0,0,0,0.5);
}
.form-row{display:flex; gap:8px; align-items:center}
label{display:block; font-size:13px; color:var(--muted); margin-top:10px}
.input,select,textarea{width:100%; padding:10px; margin-top:6px; border-radius:10px; border:1px solid rgba(255,255,255,0.04); background:transparent; color:inherit; outline:none}
.small{font-size:13px; color:var(--muted)}
.toggle{display:flex; gap:8px; align-items:center}

/* Week header (right side) */
.week-header{
  display:flex; justify-content:space-between; align-items:center; padding:12px; border-radius:10px; background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.02));
  border:1px solid rgba(255,255,255,0.02);
}

/* Week grid */
.grid-wrap{overflow:auto; min-height:460px; padding:6px}
.week-grid{display:grid; grid-template-columns: repeat(7,1fr); gap:12px; align-items:start}
.day-col{
  background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.02)); border-radius:12px; padding:10px; min-height:220px;
  display:flex; flex-direction:column; gap:8px; border:1px solid rgba(255,255,255,0.02);
  transition: box-shadow .18s ease, transform .12s ease;
}
.day-col.today{box-shadow: 0 10px 40px rgba(84,224,199,0.06); transform:translateY(-2px)}
.day-header{display:flex; justify-content:space-between; align-items:center}
.day-name{font-weight:800}
.day-date{font-size:12px; color:var(--muted)}

/* Task card */
.task{
  display:flex; gap:8px; align-items:center; padding:8px; border-radius:10px; cursor:grab; background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.04));
  border:1px solid rgba(255,255,255,0.02); transition: transform .12s ease, box-shadow .12s ease;
}
.task.dragging{opacity:0.6; transform:scale(.992); cursor:grabbing}
.task:hover{box-shadow: 0 8px 30px rgba(0,0,0,0.45)}
.task .time{min-width:62px; font-weight:800; color:var(--muted); font-size:13px}
.task .title{flex:1; font-weight:600}
.task .meta{font-size:12px; color:var(--muted)}
.task.complete{opacity:0.5; text-decoration:line-through}

/* Action chips */
.chips{display:flex; gap:6px}
.chip{padding:6px 8px; border-radius:8px; background:rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.02); cursor:pointer; font-weight:700}

/* Modal */
.modal-backdrop{position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:80}
.modal-backdrop.show{display:flex}
.modal{width:520px; max-width:96%; background:linear-gradient(180deg,#071b1b,#081221); border-radius:12px; padding:16px; border:1px solid rgba(255,255,255,0.03); box-shadow:0 20px 60px rgba(0,0,0,0.7)}
.modal h3{margin:0}
.field{margin-top:10px}

/* Toast */
.toasts{position:fixed; right:18px; bottom:18px; display:flex; flex-direction:column; gap:8px; z-index:100}

/* Archive list */
.archives{margin-top:12px; max-height:220px; overflow:auto; padding:8px; border-radius:10px; background:rgba(255,255,255,0.01)}

/* Responsive */
@media(max-width:980px){
  .main{grid-template-columns: 1fr; }
  .week-grid{grid-template-columns: repeat(2,1fr)}
}
@media(max-width:520px){
  .week-grid{grid-template-columns: 1fr}
  .logo{width:40px;height:40px}
}
</style>
</head>
<body>
<div class="app" role="application" aria-label="MCIF Weekly Task Scheduler">
  <div class="header">
    <div class="brand">
      <div class="logo" aria-hidden="true">MCIF</div>
      <div class="title">
        <h1>Weekly Task Scheduler</h1>
        <p>Plan tasks by day and assign exact times â€” weekly ISA reset, audit-ready archive</p>
      </div>
    </div>

    <div class="controls" role="toolbar" aria-label="Top controls">
      <div id="weekKeyBadge" class="kbd" aria-live="polite">â€”</div>
      <button id="prevWeek" class="btn ghost" title="Previous week">â—€</button>
      <button id="nextWeek" class="btn ghost" title="Next week">â–¶</button>
      <button id="todayBtn" class="btn" title="Jump to current week (today)">Today</button>
      <button id="exportBtn" class="btn ghost" title="Export current week JSON">Export</button>
      <button id="undoBtn" class="btn ghost" title="Undo last action">Undo</button>
    </div>
  </div>

  <div class="main">
    <!-- LEFT: controls + create -->
    <aside class="panel" aria-labelledby="createHeading">
      <h2 id="createHeading" style="margin:0">Create Task</h2>
      <div class="small" style="margin-top:6px">Assign to a day, pick a time, add notes. Keyboard: <span class="kbd">âŒ˜/Ctrl + Enter</span> to quick-add.</div>

      <div class="field">
        <label for="taskTitle">Title</label>
        <input id="taskTitle" class="input" type="text" placeholder="e.g., Finish slides for talk" autocomplete="off" />
      </div>

      <div class="form-row field">
        <div style="flex:1">
          <label for="taskDay">Day</label>
          <select id="taskDay" class="input"></select>
        </div>
        <div style="width:135px">
          <label for="taskTime">Time</label>
          <input id="taskTime" class="input" type="time" />
        </div>
      </div>

      <div class="field">
        <label for="taskNotes">Notes (optional)</label>
        <textarea id="taskNotes" class="input" rows="3" placeholder="Add steps, links, pomodoro count..."></textarea>
      </div>

      <div style="display:flex; gap:8px; margin-top:12px;">
        <button id="addTaskBtn" class="btn">Add Task</button>
        <button id="clearWeekBtn" class="btn ghost" title="Clear this week's tasks">Clear Week</button>
        <button id="importBtn" class="btn ghost" title="Import tasks JSON">Import</button>
      </div>

      <div style="margin-top:14px;" class="small">
        <label class="toggle"><input id="autoReset" type="checkbox" checked /> Reset each ISO week (archive)</label>
        <label class="toggle" style="margin-top:6px"><input id="autoSort" type="checkbox" checked /> Auto-sort tasks by time</label>
      </div>

      <div style="margin-top:14px;">
        <strong>Archives</strong>
        <div id="archiveList" class="archives small" aria-live="polite">No archives yet â€” old weeks auto-archived here.</div>
      </div>
    </aside>

    <!-- RIGHT: week view -->
    <section>
      <div class="week-header">
        <div>
          <div id="weekRange" style="font-weight:800">â€”</div>
          <div class="small" id="weekHint">Week view â€” Monâ€“Sun</div>
        </div>
        <div class="small">Timezone: <span id="tzName"></span></div>
      </div>

      <div class="grid-wrap" style="margin-top:12px;">
        <div id="weekGrid" class="week-grid" role="list" aria-label="Week tasks"></div>
      </div>
    </section>
  </div>
</div>

<!-- Edit Modal -->
<div id="modal" class="modal-backdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <h3 id="modalTitle">Edit Task</h3>
    <div class="field">
      <label for="editTitle">Title</label>
      <input id="editTitle" class="input" />
    </div>
    <div class="form-row field">
      <div style="flex:1">
        <label for="editDay">Day</label>
        <select id="editDay" class="input"></select>
      </div>
      <div style="width:140px">
        <label for="editTime">Time</label>
        <input id="editTime" class="input" type="time" />
      </div>
    </div>
    <div class="field">
      <label for="editNotes">Notes</label>
      <textarea id="editNotes" class="input" rows="4"></textarea>
    </div>

    <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px;">
      <button id="deleteBtn" class="btn ghost">Delete</button>
      <button id="closeModal" class="btn ghost">Cancel</button>
      <button id="saveBtn" class="btn">Save</button>
    </div>
  </div>
</div>

<!-- Toast container -->
<div id="toasts" class="toasts" aria-live="polite"></div>

<script>
/*
  MCIF Weekly Task Scheduler â€” v2
  Improvements (5Ã— better):
  - Modular code structure + strong comments
  - Inline edit modal (no prompts) + keyboard accessibility
  - Undo stack for last operations
  - Non-blocking toasts instead of alerts
  - Smooth drag & drop + keyboard friendly actions
  - Deterministic ISO-week handling + prev/next week navigation
  - Audit-safe archived weeks with size cap & download
  - Cleaner UX & accessibility improvements
*/

/* =========================
   Utilities & constants
   ========================= */
const DAYS = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
const STORAGE_PREFIX = 'mcif_scheduler_v2';
const SETTINGS_KEY = `${STORAGE_PREFIX}_settings`;
const ARCHIVE_INDEX_KEY = `${STORAGE_PREFIX}_archives`;
const MAX_ARCHIVE_ENTRIES = 64; // cap to prevent uncontrolled localStorage growth

function uid(prefix='id'){ return `${prefix}_${Math.random().toString(36).slice(2,9)}`; }

/* ISO week functions (Monday-first) */
function getISOWeekKey(date = new Date()){
  const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
  d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
  const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
  const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1)/7);
  return `${d.getUTCFullYear()}-W${String(weekNo).padStart(2,'0')}`;
}

/* Get Monday date of week for display */
function startOfISOWeek(date = new Date()){
  const day = new Date(date);
  const isoDay = (day.getDay() + 6) % 7; // 0=Mon
  return new Date(day.getFullYear(), day.getMonth(), day.getDate() - isoDay);
}

/* format week range like "Dec 1 â€“ Dec 7, 2025" */
function weekRangeText(date = new Date()){
  const mon = startOfISOWeek(date);
  const sun = new Date(mon.getFullYear(), mon.getMonth(), mon.getDate() + 6);
  const opts = { month:'short', day:'numeric' };
  if (mon.getFullYear() === sun.getFullYear()){
    return `${mon.toLocaleDateString(undefined,opts)} â€“ ${sun.toLocaleDateString(undefined,opts)}, ${sun.getFullYear()}`;
  }
  return `${mon.toLocaleDateString(undefined,opts)} ${mon.getFullYear()} â€“ ${sun.toLocaleDateString(undefined,opts)} ${sun.getFullYear()}`;
}

/* Storage helpers */
const storage = {
  save(key, value){ localStorage.setItem(key, JSON.stringify(value)); },
  load(key, fallback=null){ const v = localStorage.getItem(key); return v ? JSON.parse(v) : fallback; },
  remove(key){ localStorage.removeItem(key); }
};

/* Small, polite toast system */
const toastsEl = document.getElementById('toasts');
function toast(msg, opts={time:3000}){
  const id = uid('toast');
  const t = document.createElement('div');
  t.id = id;
  t.className = 'toast small';
  t.style.background = 'linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.03))';
  t.style.padding = '8px 12px'; t.style.borderRadius='10px'; t.style.border='1px solid rgba(255,255,255,0.03)';
  t.textContent = msg;
  toastsEl.appendChild(t);
  setTimeout(()=> { t.style.opacity = '0'; t.addEventListener('transitionend', ()=> t.remove()); }, opts.time);
}

/* Undo: keep last 12 actions */
class UndoStack {
  constructor(limit=12){ this.stack = []; this.limit = limit; }
  push(snapshot){ this.stack.push(JSON.stringify(snapshot)); if (this.stack.length>this.limit) this.stack.shift(); }
  pop(){ const s = this.stack.pop(); return s ? JSON.parse(s) : null; }
}
const undoStack = new UndoStack(20);

/* =========================
   App state
   ========================= */
const app = {
  weekDate: new Date(),           // date inside the currently visible week
  weekKey: getISOWeekKey(),       // computed key for storage
  tasks: {},                      // { 0: [task], 1: [...], ... 6: [...] }
  settings: {
    autoReset: true,
    autoSort: true
  },
  archives: []                    // list of archived week keys (most recent first)
};

/* Task shape:
  { id, title, notes, day(0..6), time:"HH:MM" | "", complete:bool, createdAt:timestamp }
*/

/* =========================
   DOM refs
   ========================= */
const refs = {
  weekKeyBadge: document.getElementById('weekKeyBadge'),
  weekRange: document.getElementById('weekRange'),
  tzName: document.getElementById('tzName'),
  weekGrid: document.getElementById('weekGrid'),
  taskDay: document.getElementById('taskDay'),
  taskTitle: document.getElementById('taskTitle'),
  taskTime: document.getElementById('taskTime'),
  taskNotes: document.getElementById('taskNotes'),
  addTaskBtn: document.getElementById('addTaskBtn'),
  clearWeekBtn: document.getElementById('clearWeekBtn'),
  exportBtn: document.getElementById('exportBtn'),
  importBtn: document.getElementById('importBtn'),
  prevWeek: document.getElementById('prevWeek'),
  nextWeek: document.getElementById('nextWeek'),
  todayBtn: document.getElementById('todayBtn'),
  autoReset: document.getElementById('autoReset'),
  autoSort: document.getElementById('autoSort'),
  archiveList: document.getElementById('archiveList'),
  modalBackdrop: document.getElementById('modal'),
  editTitle: document.getElementById('editTitle'),
  editDay: document.getElementById('editDay'),
  editTime: document.getElementById('editTime'),
  editNotes: document.getElementById('editNotes'),
  saveBtn: document.getElementById('saveBtn'),
  closeModal: document.getElementById('closeModal'),
  deleteBtn: document.getElementById('deleteBtn'),
  undoBtn: document.getElementById('undoBtn')
};

/* =========================
   Persistence keys
   ========================= */
function tasksKey(k){ return `${STORAGE_PREFIX}_tasks_${k}`; }
function archiveKey(k){ return `${STORAGE_PREFIX}_archive_${k}`; }

/* =========================
   Initialization
   ========================= */
function init(){
  // Load settings
  const s = storage.load(SETTINGS_KEY, null);
  if (s) app.settings = s;
  refs.autoReset.checked = !!app.settings.autoReset;
  refs.autoSort.checked = !!app.settings.autoSort;

  // Load archives index
  app.archives = storage.load(ARCHIVE_INDEX_KEY, []) || [];

  // Prepare day selectors (create & edit)
  refs.taskDay.innerHTML = DAYS.map((d,i)=>`<option value="${i}">${d}</option>`).join('');
  refs.editDay.innerHTML = refs.taskDay.innerHTML;

  // tz
  refs.tzName.textContent = Intl.DateTimeFormat().resolvedOptions().timeZone || 'local';

  // Determine current weekKey relative to app.weekDate
  app.weekKey = getISOWeekKey(app.weekDate);

  // handle weekly reset (auto archive) for existing stored weeks
  handleWeeklyResetOnLoad();

  // If tasks exist for weekKey load them; else init empty
  const loaded = storage.load(tasksKey(app.weekKey), null);
  if (loaded) app.tasks = loaded;
  else { initEmptyTasks(); saveTasks(); }

  // Render initial UI
  renderWeekHeader();
  buildGrid();
  renderAllTasks();
  renderArchiveList();

  // Bind UI events
  bindUI();

  // Periodic week rollover check (non-blocking)
  setInterval(checkWeekRollover, 30*1000);
}

/* Initialize empty tasks object (0..6) */
function initEmptyTasks(){
  app.tasks = {};
  for (let i=0;i<7;i++) app.tasks[i] = [];
}

/* Save tasks for current visible week */
function saveTasks(){
  storage.save(tasksKey(app.weekKey), app.tasks);
}

/* Save settings */
function saveSettings(){
  storage.save(SETTINGS_KEY, app.settings);
}

/* =========================
   Weekly rotation & archive logic
   ========================= */
function handleWeeklyResetOnLoad(){
  // Archive any stored tasks with a different weekKey (if autoReset enabled)
  const allKeys = Object.keys(localStorage).filter(k => k.startsWith(`${STORAGE_PREFIX}_tasks_`));
  for (const k of allKeys){
    const wk = k.replace(`${STORAGE_PREFIX}_tasks_`, '');
    if (wk !== app.weekKey){
      if (app.settings.autoReset){
        const payload = storage.load(k, null);
        if (payload){
          // archive
          storage.save(archiveKey(wk), { key: wk, tasks: payload, archivedAt: Date.now() });
          if (!app.archives.includes(wk)) app.archives.unshift(wk);
          // enforce cap
          if (app.archives.length > MAX_ARCHIVE_ENTRIES) {
            const removed = app.archives.splice(MAX_ARCHIVE_ENTRIES);
            removed.forEach(r => storage.remove(archiveKey(r)));
          }
          storage.save(ARCHIVE_INDEX_KEY, app.archives);
          localStorage.removeItem(k);
        }
      }
    }
  }
}

/* Called periodically to detect ISO week change */
function checkWeekRollover(){
  const newKey = getISOWeekKey(new Date());
  if (newKey !== getISOWeekKey(app.weekDate)){
    // user navigated away in time â€” switch to current date
    if (app.settings.autoReset){
      // archive current visible week
      storage.save(archiveKey(app.weekKey), { key: app.weekKey, tasks: app.tasks, archivedAt: Date.now() });
      if (!app.archives.includes(app.weekKey)) app.archives.unshift(app.weekKey);
      if (app.archives.length > MAX_ARCHIVE_ENTRIES){
        const removed = app.archives.splice(MAX_ARCHIVE_ENTRIES);
        removed.forEach(r=> storage.remove(archiveKey(r)));
      }
      storage.save(ARCHIVE_INDEX_KEY, app.archives);
      app.weekDate = new Date();
      app.weekKey = getISOWeekKey(app.weekDate);
      initEmptyTasks();
      saveTasks();
      renderWeekHeader();
      renderAllTasks();
      renderArchiveList();
      toast('Week changed â€” tasks reset and archived.');
    } else {
      // if not autoReset: load new week if exists, else initialize
      app.weekDate = new Date();
      app.weekKey = getISOWeekKey(app.weekDate);
      const loaded = storage.load(tasksKey(app.weekKey), null);
      if (loaded) app.tasks = loaded;
      else { initEmptyTasks(); saveTasks(); }
      renderWeekHeader();
      renderAllTasks();
    }
  }
}

/* =========================
   UI: Week header & grid
   ========================= */
function renderWeekHeader(){
  refs.weekKeyBadge.textContent = app.weekKey;
  refs.weekRange.textContent = weekRangeText(app.weekDate);
}

/* Build the day columns (Mon..Sun) */
function buildGrid(){
  refs.weekGrid.innerHTML = '';
  const mon = startOfISOWeek(app.weekDate);
  for (let i=0;i<7;i++){
    const d = new Date(mon.getFullYear(), mon.getMonth(), mon.getDate() + i);
    const col = document.createElement('div');
    col.className = 'day-col';
    col.dataset.day = i;
    if (isToday(d)) col.classList.add('today');
    col.setAttribute('role','list');
    col.setAttribute('aria-label', `Tasks for ${DAYS[i]}`);

    col.innerHTML = `
      <div class="day-header">
        <div>
          <div class="day-name">${DAYS[i]}</div>
          <div class="day-date">${d.toLocaleDateString(undefined,{month:'short',day:'numeric'})}</div>
        </div>
        <div class="small muted">${d.getFullYear()}</div>
      </div>
      <div class="task-list" style="display:flex;flex-direction:column;gap:8px" aria-live="polite"></div>
    `;

    // drag events
    const list = col.querySelector('.task-list');
    list.addEventListener('dragover', e => {
      e.preventDefault();
      list.style.outline = '2px dashed rgba(255,255,255,0.03)';
    });
    list.addEventListener('dragleave', () => list.style.outline = 'none');
    list.addEventListener('drop', e => {
      e.preventDefault();
      list.style.outline = 'none';
      const id = e.dataTransfer.getData('text/task-id');
      if (id) moveTaskToDay(id, Number(col.dataset.day));
    });

    refs.weekGrid.appendChild(col);
  }
}

/* Utility: is date today */
function isToday(d){
  const t = new Date();
  return d.getFullYear()===t.getFullYear() && d.getMonth()===t.getMonth() && d.getDate()===t.getDate();
}

/* =========================
   Task CRUD
   ========================= */
function pushUndo(){ undoStack.push({ weekKey: app.weekKey, tasks: app.tasks }); }

function addTask({title, notes, day, time}){
  if (!title || !title.trim()) { toast('Task title required.'); return; }
  pushUndo();
  const t = {
    id: uid('task'),
    title: title.trim(),
    notes: notes ? notes.trim() : '',
    day: Number(day),
    time: time || '',
    complete: false,
    createdAt: Date.now()
  };
  app.tasks[t.day].push(t);
  if (app.settings.autoSort) sortTasksForDay(t.day);
  saveTasks();
  renderAllTasks();
  toast('Task added');
}

function updateTask(id, patch){
  pushUndo();
  for (let d=0; d<7; d++){
    const idx = (app.tasks[d]||[]).findIndex(t => t.id === id);
    if (idx >= 0){
      const existing = app.tasks[d][idx];
      const updated = { ...existing, ...patch };
      // if day changed, move it
      if (patch.day !== undefined && patch.day !== d){
        app.tasks[d].splice(idx,1);
        updated.day = Number(patch.day);
        app.tasks[updated.day].push(updated);
      } else {
        app.tasks[d][idx] = updated;
      }
      if (app.settings.autoSort) sortTasksForDay(updated.day);
      saveTasks();
      renderAllTasks();
      toast('Task saved');
      return;
    }
  }
}

function deleteTask(id){
  if (!confirm('Delete task? This cannot be undone.')) return;
  pushUndo();
  for (let d=0; d<7; d++){
    const idx = (app.tasks[d]||[]).findIndex(t => t.id === id);
    if (idx >= 0){
      app.tasks[d].splice(idx,1);
      saveTasks();
      renderAllTasks();
      toast('Task deleted');
      return;
    }
  }
}

/* Move task to another day (used by DnD) */
function moveTaskToDay(id, destDay){
  pushUndo();
  for (let d=0; d<7; d++){
    const idx = (app.tasks[d]||[]).findIndex(t => t.id === id);
    if (idx >= 0){
      const t = app.tasks[d].splice(idx,1)[0];
      t.day = Number(destDay);
      app.tasks[destDay].push(t);
      if (app.settings.autoSort) sortTasksForDay(destDay);
      saveTasks();
      renderAllTasks();
      toast('Task moved');
      return;
    }
  }
}

/* Clear week */
function clearWeek(){
  if (!confirm('Clear all tasks for this visible week? This action can be undone via Undo immediately.')) return;
  pushUndo();
  initEmptyTasks();
  saveTasks();
  renderAllTasks();
  toast('Week cleared');
}

/* Sorting */
function sortTasksForDay(day){
  app.tasks[day].sort((a,b) => {
    if (!a.time && !b.time) return a.createdAt - b.createdAt;
    if (!a.time) return 1;
    if (!b.time) return -1;
    return a.time.localeCompare(b.time);
  });
}

/* =========================
   Rendering tasks
   ========================= */
function renderAllTasks(){
  for (let d=0; d<7; d++){
    const col = refs.weekGrid.querySelector(`.day-col[data-day="${d}"]`);
    if (!col) continue;
    const list = col.querySelector('.task-list');
    list.innerHTML = '';
    app.tasks[d] = app.tasks[d] || [];
    if (app.settings.autoSort) sortTasksForDay(d);
    if (app.tasks[d].length === 0){
      const hint = document.createElement('div');
      hint.className = 'small muted';
      hint.textContent = 'No tasks';
      list.appendChild(hint);
    } else {
      for (const t of app.tasks[d]){
        list.appendChild(createTaskNode(t));
      }
    }
  }
}

/* Create DOM node for task */
function createTaskNode(t){
  const node = document.createElement('div');
  node.className = 'task';
  node.draggable = true;
  node.dataset.id = t.id;
  if (t.complete) node.classList.add('complete');

  const time = document.createElement('div'); time.className='time'; time.textContent = t.time || 'â€”';
  const title = document.createElement('div'); title.className='title'; title.textContent = t.title;
  const meta = document.createElement('div'); meta.className='meta'; meta.textContent = t.notes ? (t.notes.length>60 ? t.notes.slice(0,57)+'...' : t.notes) : '';
  const actions = document.createElement('div'); actions.className='chips';

  const completeBtn = document.createElement('button'); completeBtn.className='chip'; completeBtn.title='Toggle complete'; completeBtn.textContent = t.complete ? 'â†º' : 'âœ“';
  completeBtn.addEventListener('click', e => {
    e.stopPropagation();
    updateTask(t.id, { complete: !t.complete });
  });

  const editBtn = document.createElement('button'); editBtn.className='chip'; editBtn.title='Edit'; editBtn.textContent = 'âœŽ';
  editBtn.addEventListener('click', e => { e.stopPropagation(); openEditModal(t); });

  const delBtn = document.createElement('button'); delBtn.className='chip'; delBtn.title='Delete'; delBtn.textContent = 'ðŸ—‘';
  delBtn.addEventListener('click', e => { e.stopPropagation(); deleteTask(t.id); });

  actions.appendChild(completeBtn); actions.appendChild(editBtn); actions.appendChild(delBtn);

  const left = document.createElement('div'); left.style.display='flex'; left.style.flexDirection='column'; left.style.gap='6px';
  left.appendChild(title); left.appendChild(meta);

  node.appendChild(time); node.appendChild(left); node.appendChild(actions);

  // drag behavior
  node.addEventListener('dragstart', ev => {
    node.classList.add('dragging');
    ev.dataTransfer.setData('text/task-id', t.id);
    ev.dataTransfer.effectAllowed = 'move';
  });
  node.addEventListener('dragend', () => node.classList.remove('dragging'));

  // keyboard focus: Enter open edit, Delete prompt delete
  node.tabIndex = 0;
  node.addEventListener('keydown', ev => {
    if (ev.key === 'Enter') openEditModal(t);
    if (ev.key === 'Delete') deleteTask(t.id);
  });

  // double click quick edit
  node.addEventListener('dblclick', () => openEditModal(t));

  // tooltip for notes
  if (t.notes) node.title = t.notes;

  return node;
}

/* =========================
   Modal (edit) functionality
   ========================= */
let activeEditTaskId = null;

function openEditModal(task){
  activeEditTaskId = task.id;
  refs.editTitle.value = task.title;
  refs.editDay.value = String(task.day);
  refs.editTime.value = task.time || '';
  refs.editNotes.value = task.notes || '';
  showModal(true);
  refs.editTitle.focus();
}

function showModal(show=true){
  refs.modalBackdrop.classList.toggle('show', show);
  refs.modalBackdrop.setAttribute('aria-hidden', String(!show));
}

function closeModal(){
  activeEditTaskId = null;
  showModal(false);
}

/* Save modal changes */
function saveModal(){
  if (!activeEditTaskId) return;
  const payload = {
    title: refs.editTitle.value.trim() || 'Untitled',
    notes: refs.editNotes.value.trim(),
    time: refs.editTime.value || '',
    day: Number(refs.editDay.value)
  };
  updateTask(activeEditTaskId, payload);
  closeModal();
}

/* Delete from modal */
function deleteFromModal(){
  if (!activeEditTaskId) return;
  if (!confirm('Delete task? This cannot be undone.')) return;
  deleteTask(activeEditTaskId);
  closeModal();
}

/* =========================
   Import / Export / Archives
   ========================= */
function exportCurrentWeek(){
  const payload = { weekKey: app.weekKey, tasks: app.tasks, exportedAt: Date.now() };
  const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(payload, null, 2));
  const a = document.createElement('a'); a.href = dataStr; a.download = `mcif_tasks_${app.weekKey}.json`; document.body.appendChild(a); a.click(); a.remove();
  toast('Exported current week JSON');
}

function importJSON(){
  const input = document.createElement('input'); input.type='file'; input.accept='application/json';
  input.addEventListener('change', async e => {
    const file = e.target.files[0]; if (!file) return;
    const text = await file.text();
    try {
      const obj = JSON.parse(text);
      if (!obj.weekKey || !obj.tasks) throw new Error('Invalid file');
      if (obj.weekKey !== app.weekKey){
        if (!confirm(`Import is for ${obj.weekKey}. Replace visible week ${app.weekKey}?`)) return;
      }
      pushUndo();
      app.tasks = obj.tasks;
      saveTasks();
      renderAllTasks();
      toast('Import complete');
    } catch(err){ toast('Import failed: ' + err.message); }
  });
  input.click();
}

/* Archive management UI */
function renderArchiveList(){
  refs.archiveList.innerHTML = '';
  if (!app.archives || app.archives.length === 0){
    refs.archiveList.textContent = 'No archives yet â€” old weeks auto-archived here.';
    return;
  }
  for (const k of app.archives.slice(0, MAX_ARCHIVE_ENTRIES)){
    const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.marginBottom='8px';
    const left = document.createElement('div'); left.innerHTML = `<strong>${k}</strong><div class="small muted">Archived</div>`;
    const actions = document.createElement('div');
    const openBtn = document.createElement('button'); openBtn.className='btn ghost'; openBtn.textContent='Open';
    openBtn.addEventListener('click', ()=> openArchive(k));
    const dlBtn = document.createElement('button'); dlBtn.className='btn ghost'; dlBtn.textContent='Download';
    dlBtn.addEventListener('click', ()=> downloadArchive(k));
    actions.appendChild(openBtn); actions.appendChild(dlBtn);
    row.appendChild(left); row.appendChild(actions);
    refs.archiveList.appendChild(row);
  }
}

function openArchive(k){
  const payload = storage.load(archiveKey(k), null);
  if (!payload){ toast('Archive missing'); return; }
  const count = Object.values(payload.tasks).reduce((s,arr)=> s + (arr?.length||0), 0);
  alert(`Archive ${k}\nTasks: ${count}\nArchived at: ${new Date(payload.archivedAt).toLocaleString()}`);
}

function downloadArchive(k){
  const payload = storage.load(archiveKey(k), null);
  if (!payload){ toast('Archive missing'); return; }
  const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(payload, null, 2));
  const a = document.createElement('a'); a.href = dataStr; a.download = `mcif_archive_${k}.json`; document.body.appendChild(a); a.click(); a.remove();
}

/* =========================
   Navigation: prev/next week and today
   ========================= */
function gotoWeek(offsetWeeks = 0){
  if (offsetWeeks !== 0){
    const newDate = new Date(app.weekDate);
    newDate.setDate(newDate.getDate() + offsetWeeks * 7);
    app.weekDate = newDate;
  } else {
    app.weekDate = new Date();
  }
  app.weekKey = getISOWeekKey(app.weekDate);
  // load tasks for new visible week (create empty if none)
  const loaded = storage.load(tasksKey(app.weekKey), null);
  if (loaded) app.tasks = loaded;
  else { initEmptyTasks(); saveTasks(); }
  renderWeekHeader();
  buildGrid();
  renderAllTasks();
}

/* =========================
   Undo
   ========================= */
function undo(){
  const snapshot = undoStack.pop();
  if (!snapshot){ toast('Nothing to undo'); return; }
  if (snapshot.weekKey !== app.weekKey){
    // If snapshot was for another week, replace visible week to that snapshot's week
    app.weekKey = snapshot.weekKey;
    app.weekDate = new Date();
    // We attempt to set weekDate to the snapshot week by parsing iso week -> approximate date
    // For simplicity set to today (UI will show correct weekKey)
  }
  app.tasks = snapshot.tasks;
  saveTasks();
  renderAllTasks();
  toast('Undone');
}

/* =========================
   UI bindings
   ========================= */
function bindUI(){
  refs.addTaskBtn.addEventListener('click', ()=> {
    addTask({
      title: refs.taskTitle.value,
      notes: refs.taskNotes.value,
      day: refs.taskDay.value,
      time: refs.taskTime.value
    });
    refs.taskTitle.value=''; refs.taskNotes.value=''; refs.taskTime.value='';
    refs.taskTitle.focus();
  });

  refs.clearWeekBtn.addEventListener('click', clearWeek);
  refs.exportBtn.addEventListener('click', exportCurrentWeek);
  refs.importBtn.addEventListener('click', importJSON);
  refs.prevWeek.addEventListener('click', ()=>{ gotoWeek(-1); });
  refs.nextWeek.addEventListener('click', ()=>{ gotoWeek(1); });
  refs.todayBtn.addEventListener('click', ()=>{ gotoWeek(0); });
  refs.autoReset.addEventListener('change', e => { app.settings.autoReset = e.target.checked; saveSettings(); toast('Auto-reset updated'); });
  refs.autoSort.addEventListener('change', e => { app.settings.autoSort = e.target.checked; saveSettings(); renderAllTasks(); toast('Auto-sort updated'); });

  // modal buttons
  refs.saveBtn.addEventListener('click', saveModal);
  refs.closeModal.addEventListener('click', closeModal);
  refs.deleteBtn.addEventListener('click', deleteFromModal);

  // keyboard shortcuts: Ctrl/Cmd+Enter add, Ctrl+Z undo
  document.addEventListener('keydown', e => {
    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter'){
      if (document.activeElement === refs.taskTitle || document.activeElement === refs.taskNotes) refs.addTaskBtn.click();
      else addTask({ title: refs.taskTitle.value, notes: refs.taskNotes.value, day: refs.taskDay.value, time: refs.taskTime.value });
    }
    if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'z'){ undo(); }
  });

  // undo button
  refs.undoBtn.addEventListener('click', undo);

  // modal ESC to close
  document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });

  // quick import when user drags a JSON file onto the app
  window.addEventListener('drop', async (ev) => {
    ev.preventDefault();
    if (!ev.dataTransfer.files?.length) return;
    const f = ev.dataTransfer.files[0];
    if (f.type === 'application/json' || /\.json$/i.test(f.name)){
      const text = await f.text();
      try{
        const obj = JSON.parse(text);
        if (!obj.weekKey || !obj.tasks) throw new Error('Invalid file');
        if (!confirm(`Import file for ${obj.weekKey}? Replaces current visible week.`)) return;
        pushUndo();
        app.tasks = obj.tasks;
        saveTasks();
        renderAllTasks();
        toast('Import successful');
      } catch(err){ toast('Import failed: ' + err.message); }
    }
  });
  window.addEventListener('dragover', e => e.preventDefault());
}

/* =========================
   Startup
   ========================= */
init();

/* Expose for power users */
window.mcifScheduler = {
  app, addTask, updateTask, deleteTask, exportCurrentWeek, importJSON, undo
};
</script>
</body>
</html>