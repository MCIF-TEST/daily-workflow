<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Flow Enterprise Pro • Editable A/B Scheduler + Pomodoro + Notes</title>
<style>
  :root{--bg:#0d1117;--card:#161b22;--text:#f0f6fc;--accent:#58a6ff;--success:#238636;--danger:#da3633;--warning:#f1c232;--input-bg:rgba(255,255,255,0.05)}
  [data-theme="light"]{--bg:#fafafa;--card:#fff;--text:#24292f;--accent:#0969da;--success:#2ea44f;--danger:#da3633;--warning:#f1c232;--input-bg:rgba(0,0,0,0.05)}
  [data-theme="forest"]{--bg:#0a180a;--card:#132613;--text:#e6ffed;--accent:#56d364;--success:#3fb950;--danger:#da3633;--warning:#f1c232;--input-bg:rgba(255,255,255,0.05)}
  [data-theme="sunrise"]{--bg:#fff4e6;--card:#ffe8cc;--text:#7c2d12;--accent:#ea580c;--success:#dc2626;--danger:#da3633;--warning:#f1c232;--input-bg:rgba(0,0,0,0.05)}

  *{box-sizing:border-box;margin:0;padding:0;font-family:system-ui,Arial,sans-serif}
  body{background:var(--bg);color:var(--text);min-height:100vh;display:grid;place-items:center;padding:16px;line-height:1.5}
  .app{max-width:560px;width:100%;display:grid;gap:24px}
  h1{font-size:2.2rem;text-align:center;margin-bottom:8px}
  .controls{display:flex;justify-content:center;align-items:center;gap:12px;flex-wrap:wrap}
  .tab{padding:10px 20px;border-radius:50px;background:var(--card);cursor:pointer;font-weight:600;transition:0.2s}
  .tab.active{background:var(--accent);color:white}
  select, button{background:var(--card);color:var(--text);border:none;border-radius:8px;padding:10px 14px;font-size:1rem;cursor:pointer}
  .card{background:var(--card);border-radius:16px;padding:24px;box-shadow:0 8px 32px rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.08)}
  .activity{
    display:grid;grid-template-columns:auto auto 1fr auto auto auto;gap:12px;align-items:center;
    padding:12px;background:var(--input-bg);border-radius:12px;margin:10px 0;
    cursor:grab;
  }
  .activity input[type=checkbox]{width:20px;height:20px;cursor:pointer}
  .activity:active{cursor:grabbing;opacity:0.7}
  .activity input[type=text]{background:transparent;border:none;color:var(--text);font-size:1.1rem;padding:4px}
  .activity input[type=number]{width:60px;padding:6px;background:var(--input-bg);border-radius:6px;text-align:center}
  .activity button{background:none;border:none;font-size:1.4rem;cursor:pointer;padding:4px}
  .activity button:hover{color:var(--danger)}
  .add-btn{background:var(--success);color:white;font-size:1.5rem;width:48px;height:48px;border-radius:50%;display:grid;place-items:center;margin:20px auto 0}
  .timer{font-size:3rem;font-weight:bold;text-align:center;margin:20px 0;letter-spacing:3px}
  .progress-ring{width:140px;height:140px;margin:0 auto;position:relative}
  .progress-ring svg{width:100%;height:100%;transform:rotate(-90deg)}
  .progress-ring circle{fill:none;stroke-width:12}
  .progress-ring .bg{stroke:#3336}
  .progress-ring .fg{stroke:var(--success);stroke-dasharray:377;stroke-dashoffset:377;transition:stroke-dashoffset 0.8s ease}
  .progress-text{position:absolute;inset:0;display:grid;place-items:center;font-size:2rem;font-weight:bold}
  .section{margin-top:24px}
  .notes-bank{max-height:300px;overflow-y:auto}
  .note{padding:12px;background:var(--input-bg);border-radius:8px;margin:10px 0;display:flex;flex-direction:column;gap:8px}
  .note-text{font-size:1rem;white-space:pre-wrap}
  .note-time{opacity:0.6;font-size:0.8rem}
  .note-actions{display:flex;gap:8px}
  .note-actions button{font-size:0.9rem;padding:4px 8px;background:var(--warning);color:var(--text);border-radius:4px}
  .note-actions button:hover{background:var(--danger)}
  textarea{width:100%;min-height:100px;background:var(--input-bg);color:var(--text);border:none;border-radius:8px;padding:12px}
  #exportOpts{display:flex;gap:12px;align-items:center;justify-content:center;flex-wrap:wrap}
  .pomodoro-section{text-align:center}
  .pomodoro-controls{display:flex;gap:12px;justify-content:center;margin-top:12px}
  .pomodoro-controls button{background:var(--accent);color:white;padding:10px 20px;border-radius:8px;font-weight:600}
  .pomodoro-controls button:disabled{opacity:0.5;cursor:not-allowed}
  footer{text-align:center;opacity:0.7;font-size:0.9rem}
</style>
</head>
<body>

<div class="app">
  <h1>Flow Enterprise Pro</h1>

  <div class="controls">
    <div class="tab active" data-day="A">Day A</div>
    <div class="tab" data-day="B">Day B</div>
    <select id="theme">
      <option value="dark">Dark</option>
      <option value="light">Light</option>
      <option value="forest">Forest</option>
      <option value="sunrise">Sunrise</option>
    </select>
    <button id="calendarBtn">Calendar</button>
    <button id="weeklyBtn">Weekly View</button>
  </div>

  <div class="card">
    <div id="list"></div>
    <button class="add-btn" id="addActBtn">+</button>
    <div class="timer" id="timer">00:00</div>
    <div class="progress-ring">
      <svg><circle class="bg" cx="70" cy="70" r="60"/><circle class="fg" cx="70" cy="70" r="60"/></svg>
      <div class="progress-text" id="percent">0%</div>
    </div>

    <div class="section pomodoro-section">
      <h2>Pomodoro Timer</h2>
      <div class="timer" id="pomoTimer">25:00</div>
      <div class="pomodoro-controls">
        <button id="startPomo">Start</button>
        <button id="pausePomo">Pause</button>
        <button id="resetPomo">Reset</button>
      </div>
      <p id="pomoStatus">Work Session</p>
    </div>

    <div class="section">
      <h2>Notes Bank</h2>
      <textarea id="newNote" placeholder="Add a note..."></textarea>
      <button id="addNoteBtn" style="background:var(--success);color:white;margin-top:8px">Add Note</button>
      <div class="notes-bank" id="notesList"></div>
      <div id="exportOpts">
        <button id="exportNotes">Export Notes</button>
        <select id="exportFormat">
          <option value="json">JSON</option>
          <option value="csv">CSV</option>
          <option value="txt">TXT</option>
        </select>
        <input type="date" id="exportStart">
        <input type="date" id="exportEnd">
      </div>
    </div>
  </div>

  <footer>Enterprise Pro: Auto daily reset • Fail-safe saves • Pomodoro integrated</footer>
</div>

<script>
// Enterprise Storage: IndexedDB with enhanced error handling
let db;
const dbName = 'FlowEnterpriseProDB';
const req = indexedDB.open(dbName, 2);
req.onerror = () => alert('Database error - check permissions and try again');
req.onsuccess = () => { db = req.result; loadAll(); };
req.onupgradeneeded = e => {
  db = e.target.result;
  if (!db.objectStoreNames.contains('schedules')) db.createObjectStore('schedules', {keyPath: 'day'});
  if (!db.objectStoreNames.contains('dailyLogs')) db.createObjectStore('dailyLogs', {keyPath: 'date'});
  if (!db.objectStoreNames.contains('notes')) db.createObjectStore('notes', {keyPath: 'id', autoIncrement: true});
  if (!db.objectStoreNames.contains('settings')) db.createObjectStore('settings', {keyPath: 'key'});
};

// Defaults
const defaults = {
  A: [{name:"Reading", mins:60, done:false}, {name:"College Class", mins:60, done:false}, {name:"News Study", mins:30, done:false}, {name:"Bible Read", mins:45, done:false}],
  B: [{name:"Reading", mins:60, done:false}, {name:"GED Study", mins:60, done:false}, {name:"College Class", mins:60, done:false}, {name:"News Study", mins:30, done:false}, {name:"Bible Read", mins:30, done:false}]
};

let currentDay = localStorage.getItem("day") || "A";
let activities = [];
let notes = [];
let timerInterval, timerSeconds = 0;
let lastResetDate = localStorage.getItem('lastReset') || new Date().toISOString().split('T')[0];

// Pomodoro State
let pomoInterval, pomoSeconds = 0;
let isPomoRunning = false;
let isWork = true;
let workTime = 25 * 60;
let breakTime = 5 * 60;
let pomoStatus = document.getElementById('pomoStatus');

const list = document.getElementById("list");
const timerEl = document.getElementById("timer");
const fg = document.querySelector(".fg");
const notesList = document.getElementById("notesList");
const pomoTimerEl = document.getElementById('pomoTimer');

// Load All
function loadAll() {
  checkDailyReset();
  loadSchedule();
  loadNotes();
  render();
  renderNotes();
  updatePomoDisplay();
}

// Daily Reset & Archive
function checkDailyReset() {
  const today = new Date().toISOString().split('T')[0];
  if (today !== lastResetDate) {
    archiveDay(lastResetDate);
    resetDones();
    localStorage.setItem('lastReset', today);
    lastResetDate = today;
  }
}

function resetDones() {
  activities.forEach(a => a.done = false);
  saveSchedule();
}

function archiveDay(date) {
  if (!activities.length) return;
  const log = {date, dayType: currentDay, activities: activities.map(a => ({...a}))};
  const tx = db.transaction('dailyLogs', 'readwrite');
  const store = tx.objectStore('dailyLogs');
  const putReq = store.put(log);
  putReq.onsuccess = () => console.log(`Archived ${date}`);
  putReq.onerror = () => console.error('Archive failed');
  tx.oncomplete = () => {};
  tx.onerror = () => alert('Archive error');
}

// Load/Save Schedule
function loadSchedule() {
  const tx = db.transaction('schedules');
  const getReq = tx.objectStore('schedules').get(currentDay);
  getReq.onsuccess = e => {
    activities = e.target.result?.acts || defaults[currentDay].map(a => ({...a}));
    render();
  };
  getReq.onerror = () => alert('Load schedule failed');
}

function saveSchedule() {
  const tx = db.transaction('schedules', 'readwrite');
  const store = tx.objectStore('schedules');
  const putReq = store.put({day: currentDay, acts: activities});
  putReq.onsuccess = () => console.log('Saved');
  putReq.onerror = () => alert('Save failed');
}

// Render Activities
function render() {
  list.innerHTML = "";
  activities.forEach((act, i) => {
    const div = document.createElement("div");
    div.className = "activity";
    div.draggable = true;
    div.innerHTML = `
      <input type="checkbox" ${act.done ? 'checked' : ''} data-i="${i}" class="done">
      <input type="text" value="${act.name}" data-i="${i}" class="name">
      <input type="number" value="${act.mins}" data-i="${i}" class="mins">
      <button data-i="${i}" title="Start timer">&#9654;</button>
      <button data-i="${i}" title="Delete">&#128465;</button>
    `;
    list.appendChild(div);

    div.querySelector(".done").onchange = e => { act.done = e.target.checked; saveSchedule(); render(); };
    div.querySelector(".name").onblur = e => { act.name = e.target.value; saveSchedule(); };
    div.querySelector(".mins").onblur = e => { act.mins = parseInt(e.target.value) || 1; saveSchedule(); };
    div.querySelector("button:nth-of-type(1)").onclick = () => startTimer(act.mins);
    div.querySelector("button:nth-of-type(2)").onclick = () => { activities.splice(i,1); saveSchedule(); };

    div.ondragstart = e => e.dataTransfer.setData("text", i);
    div.ondragover = e => e.preventDefault();
    div.ondrop = e => {
      e.preventDefault();
      const from = e.dataTransfer.getData("text");
      const to = i;
      if (from !== to) {
        const [moved] = activities.splice(from,1);
        activities.splice(to,0,moved);
        saveSchedule();
      }
    };
  });

  const totalMins = activities.reduce((a,c)=>a+c.mins,0);
  const doneMins = activities.reduce((a,c)=>a+(c.done ? c.mins : 0),0);
  const pct = totalMins ? Math.round((doneMins / totalMins) * 100) : 0;
  fg.style.strokeDashoffset = 377 - (377 * pct / 100);
  document.getElementById("percent").textContent = pct + "%";
}

// Add Activity
document.getElementById("addActBtn").onclick = () => {
  activities.push({name:"New", mins:30, done:false});
  saveSchedule();
};

// Activity Timer
function startTimer(mins) {
  clearInterval(timerInterval);
  timerSeconds = mins * 60;
  timerInterval = setInterval(() => {
    timerSeconds--;
    const m = String(Math.floor(timerSeconds/60)).padStart(2,"0");
    const s = String(timerSeconds%60).padStart(2,"0");
    timerEl.textContent = `${m}:${s}`;
    if (timerSeconds <= 0) { clearInterval(timerInterval); alert('Timer done!'); }
  }, 1000);
  timerEl.textContent = `${String(mins).padStart(2,"0")}:00`;
}

// Day Switch
document.querySelectorAll(".tab").forEach(t => {
  t.onclick = () => {
    document.querySelector(".tab.active").classList.remove("active");
    t.classList.add("active");
    currentDay = t.dataset.day;
    localStorage.setItem("day", currentDay);
    loadSchedule();
    clearInterval(timerInterval);
    timerEl.textContent = "00:00";
  };
  if (t.dataset.day === currentDay) t.classList.add("active");
});

// Theme
const themeSel = document.getElementById("theme");
themeSel.value = localStorage.getItem("theme") || "dark";
document.documentElement.dataset.theme = themeSel.value;
themeSel.onchange = e => {
  document.documentElement.dataset.theme = e.target.value;
  localStorage.setItem("theme", e.target.value);
};

// Calendar Log View
document.getElementById("calendarBtn").onclick = () => {
  const date = prompt("View log for date (YYYY-MM-DD):");
  if (date) {
    const tx = db.transaction('dailyLogs');
    tx.objectStore('dailyLogs').get(date).onsuccess = e => {
      const log = e.target.result;
      if (log) {
        const done = log.activities.filter(a => a.done).map(a => a.name).join(', ') || 'None';
        const notDone = log.activities.filter(a => !a.done).map(a => a.name).join(', ') || 'None';
        alert(`Log for ${date} (${log.dayType} Day):\nDone: ${done}\nNot Done: ${notDone}`);
      } else alert('No log');
    };
  }
};

// Weekly View (Accurate to Date, Assume A on even days, B on odd - Customize)
document.getElementById("weeklyBtn").onclick = () => {
  const now = new Date(2025, 11, 3); // Dec 3, 2025
  const weekStart = new Date(now);
  weekStart.setDate(now.getDate() - now.getDay());
  let weekStr = 'Weekly Schedule (A on even dates, B on odd):\n';
  for (let i = 0; i < 7; i++) {
    const d = new Date(weekStart);
    d.setDate(weekStart.getDate() + i);
    const dayType = d.getDate() % 2 === 0 ? 'A' : 'B';
    weekStr += `${d.toDateString()}: ${dayType} Day\n`;
  }
  alert(weekStr);
};

// Pomodoro Timer
function updatePomoDisplay() {
  const secs = isWork ? workTime : breakTime;
  const m = String(Math.floor(secs / 60)).padStart(2, '0');
  const s = String(secs % 60).padStart(2, '0');
  pomoTimerEl.textContent = `${m}:${s}`;
  pomoStatus.textContent = isWork ? 'Work Session' : 'Break Time';
}

document.getElementById('startPomo').onclick = () => {
  if (!isPomoRunning) {
    pomoSeconds = isWork ? workTime : breakTime;
    isPomoRunning = true;
    pomoInterval = setInterval(() => {
      pomoSeconds--;
      const m = String(Math.floor(pomoSeconds / 60)).padStart(2, '0');
      const s = String(pomoSeconds % 60).padStart(2, '0');
      pomoTimerEl.textContent = `${m}:${s}`;
      if (pomoSeconds <= 0) {
        clearInterval(pomoInterval);
        isPomoRunning = false;
        alert(isWork ? 'Work done! Take a break.' : 'Break over! Back to work.');
        isWork = !isWork;
        updatePomoDisplay();
      }
    }, 1000);
    updatePomoDisplay();
  }
};

document.getElementById('pausePomo').onclick = () => {
  clearInterval(pomoInterval);
  isPomoRunning = false;
};

document.getElementById('resetPomo').onclick = () => {
  clearInterval(pomoInterval);
  isPomoRunning = false;
  isWork = true;
  updatePomoDisplay();
};

// Notes (Unchanged, robust)
function loadNotes() {
  notes = [];
  const tx = db.transaction('notes');
  tx.objectStore('notes').openCursor().onsuccess = e => {
    const cur = e.target.result;
    if (cur) {
      notes.push(cur.value);
      cur.continue();
    } else renderNotes();
  };
}

function saveNote(note) {
  const tx = db.transaction('notes', 'readwrite');
  const addReq = tx.objectStore('notes').add(note);
  addReq.onsuccess = loadNotes;
  addReq.onerror = () => alert('Note save failed');
}

function updateNote(id, text) {
  const tx = db.transaction('notes', 'readwrite');
  tx.objectStore('notes').get(id).onsuccess = e => {
    let n = e.target.result;
    n.text = text;
    tx.objectStore('notes').put(n);
  };
  tx.oncomplete = loadNotes;
}

function deleteNote(id) {
  const tx = db.transaction('notes', 'readwrite');
  tx.objectStore('notes').delete(id);
  tx.oncomplete = loadNotes;
}

function renderNotes() {
  notesList.innerHTML = '';
  notes.forEach(n => {
    const div = document.createElement('div');
    div.className = 'note';
    div.innerHTML = `
      <textarea class="note-text">${n.text}</textarea>
      <span class="note-time">${new Date(n.timestamp).toLocaleString()}</span>
      <div class="note-actions">
        <button class="saveNote" data-id="${n.id}">Save</button>
        <button class="delNote" data-id="${n.id}">Delete</button>
      </div>
    `;
    notesList.appendChild(div);

    div.querySelector('.saveNote').onclick = () => updateNote(n.id, div.querySelector('textarea').value);
    div.querySelector('.delNote').onclick = () => deleteNote(n.id);
  });
}

document.getElementById('addNoteBtn').onclick = () => {
  const text = document.getElementById('newNote').value.trim();
  if (text) {
    saveNote({text, timestamp: Date.now()});
    document.getElementById('newNote').value = '';
  }
};

// Export Notes
document.getElementById('exportNotes').onclick = () => {
  const format = document.getElementById('exportFormat').value;
  const start = document.getElementById('exportStart').value ? new Date(document.getElementById('exportStart').value).getTime() : 0;
  const end = document.getElementById('exportEnd').value ? new Date(document.getElementById('exportEnd').value).getTime() : Date.now();
  const filtered = notes.filter(n => n.timestamp >= start && n.timestamp <= end);

  let data;
  if (format === 'json') data = JSON.stringify(filtered, null, 2);
  else if (format === 'csv') data = 'ID,Time,Text\n' + filtered.map(n => `${n.id},"${new Date(n.timestamp).toLocaleString()}","${n.text.replace(/"/g, '""')}"`).join('\n');
  else if (format === 'txt') data = filtered.map(n => `---\n${new Date(n.timestamp).toLocaleString()}\n${n.text}\n`).join('');

  const blob = new Blob([data], {type: `text/${format}`});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `notes_${new Date().toISOString().split('T')[0]}.${format}`;
  a.click();
  URL.revokeObjectURL(url);
};
</script>
</body>
</html>
